프로젝트 실습

> 175.45.192.42 / E5$dGh565RDn

# apt install software-properties-common -y
# add-apt-repository ppa:oisf/suricata-stable


# apt update
# apt upgrade

# apt install suricata jq

# suricata -V
# systemctl status suricata

# ip ad
eth0

# vi /etc/suricata/suricata.yaml

af-packet:- interface: eth0
	cluster-id: 99
	cluster-type: cluster_flow
	defrag: yes
	use-mmap: yes	# 활성화
	tpacket-v3: yes	# 활성화


# suricata-update
>  ll /var/lib/suricata/rules/


# suricata -c /etc/suricata/suricata.yaml -i eth0
# tail -f /var/log/suricata/stats.log
# tail -f /var/log/suricata/fast.log


* -q : iptables ...

------

# apt install -y nginx
# systemctl start nginx
# systemctl enable nginx
# systemctl status nginx

> ubuntu 22.04 버전 80번 포트 오류 해결
# vi /etc/nginx/site-enabled/default : 23번째 줄 listen [::] 80~ 주석 처리


# wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo gpg --dearmor -o /usr/share/keyrings/elasticsearch-keyring.gpg

# echo "deb [signed-by=/usr/share/keyrings/elasticsearch-keyring.gpg] https://artifacts.elastic.co/packages/8.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-8.x.list

메뉴얼 :
# wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-8.15.1-amd64.deb
# dpkg -i elasticsearch-8.15.1-amd64.deb


# vi /etc/elasticsearch/elasticsearch.yml
> network.host: 0.0.0.0

> discovery.seed_hosts: ["0.0.0.0"]

# systemctl start elasticsearch
# systemctl enable elasticsearch
# systemctl status elasticsearch

# curl -X GET "175.45.192.42:9200"
> http://175.45.192.42:9200/
 
# vi /etc/elasticsearch/elasticsearch.yml
> xpack.security.enabled: false x 4

# curl -X GET "175.45.192.42:9200"
> http://175.45.192.42:9200/

------

# apt install kibana

# systemctl start kibana
# systemctl enable kibana
# systemctl status kibana


# cp /etc/nginx/sites-available/default /etc/nginx/sites-available/default_backup

# vi /etc/nginx/sites-available/default
> gg
> dG

server {
    listen 80;

    server_name _;

    location / {
        proxy_pass http://localhost:5601;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}

------
logstash

# apt install logstash


# vi /etc/logstash/conf.d/beats-input.conf
input {
  beats {
    port => 5044
  }
}

# vi /etc/logstash/conf.d/elasticsearch-output.conf
output {
  if [@metadata][pipeline] {
	elasticsearch {
  	hosts => ["localhost:9200"]
  	manage_template => false
  	index => "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
  	pipeline => "%{[@metadata][pipeline]}"
	}
  } else {
	elasticsearch {
  	hosts => ["localhost:9200"]
  	manage_template => false
  	index => "%{[@metadata][beat]}-%{[@metadata][version]}-%{+YYYY.MM.dd}"
	}
  }
}

# -u logstash /usr/share/logstash/bin/logstash --path.settings /etc/logstash -t


# systemctl enable logstash
# systemctl start logstash
# systemctl status logstash


------
security

> 123!@# / kibana

# vi /etc/elasticsearch/elasticsearch.yml
...
xpack.security.enabled: true #
...
...
xpack.security.transport.ssl:
  enabled: true #
...

# systemctl restart elasticsearch
> http://175.45.192.42:9200/

# /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic -i

# /usr/share/elasticsearch/bin/elasticsearch-reset-password -u kibana_system -i

# vi /etc/kibana/kibana.yml
...
elasticsearch.username: "kibana_system"
elasticsearch.password: "패스"
...

# systemctl restart kibana
# systemctl status kibana
> http://175.45.192.42


------
filebeat

> 'Also available in Beats'

# curl -L -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.15.1-amd64.deb
# sudo dpkg -i filebeat-8.15.1-amd64.deb


# vi /etc/filebeat/filebeat.yml
...
setup.kibana:
  host: "localhost:5601"   #
...
...
output.elasticsearch:
  hosts: ["175.45.192.42:9200"]    #
...
  username: "elastic"    #
  password: "패스"    #
...

# filebeat modules enable suricata

# vi /etc/filebeat/modules.d/suricata.yml
...
 eve:
    enabled: true    #
...

# filebeat setup

# service filebeat start
# service filebeat status

> Check data
> Suricata Events Overview





















